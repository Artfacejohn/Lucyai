<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucy — Live Avatar Loop</title>

<style>
html,body{
  height:100%;
  margin:0;
  background:#000;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
.stage{
  position:fixed;
  inset:0;
  display:grid;
  place-items:center;
  background:#000;
}
video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}
[hidden]{display:none!important;}
.ui{
  position:fixed;
  left:12px;
  bottom:12px;
  display:flex;
  gap:8px;
  align-items:center;
  color:#ddd;
  z-index:10;
  flex-wrap:wrap;
}
button,input[type=range]{
  appearance:none;
  border:1px solid #333;
  background:#111;
  color:#eee;
  padding:8px 12px;
  border-radius:10px;
}
label{font-size:12px;opacity:.85}
.hint{
  position:fixed;
  left:12px;
  top:12px;
  color:#bbb;
  font-size:12px;
  max-width:72ch;
}
</style>
</head>

<body>

<div class="stage">

  <!-- Base -->
  <video id="idleBase" src="idle.mp4" muted playsinline loop preload="auto"></video>
  <video id="idle02" src="idle02.mp4" muted playsinline preload="auto" hidden></video>
  <video id="talk" src="talk.mp4" muted playsinline loop preload="auto" hidden style="z-index:5"></video>

  <!-- Specials -->
  <video id="idleHair"  src="idlehair.mp4"  muted playsinline preload="auto" hidden></video>
  <video id="idleFire"  src="idlefire.mp4"  muted playsinline preload="auto" hidden></video>
  <video id="idleDance" src="dance.mp4"     muted playsinline preload="auto" hidden></video>
  <video id="idleSilly" src="silly.mp4"     muted playsinline preload="auto" hidden></video>
  <video id="idleApple" src="apple.mp4"     muted playsinline preload="auto" hidden></video>

</div>

<div class="hint">
Chromebook mode • Files must be in same folder • Capture tab audio if available, mic fallback • Manual Talk for testing
</div>

<div class="ui">
  <button id="capture">Capture Audio</button>
  <label>Sensitivity
    <input id="sens" type="range" min="1" max="100" value="35">
  </label>
  <button id="manualTalk">Manual Talk</button>
  <span id="status" style="opacity:.8;font-size:.9rem">Idle</span>
</div>

<script>
(() => {

const el = {
  idle:  document.getElementById('idleBase'),
  idle02:document.getElementById('idle02'),
  talk:  document.getElementById('talk'),
  hair:  document.getElementById('idleHair'),
  fire:  document.getElementById('idleFire'),
  dance: document.getElementById('idleDance'),
  silly: document.getElementById('idleSilly'),
  apple: document.getElementById('idleApple'),
  btn:   document.getElementById('capture'),
  sens:  document.getElementById('sens'),
  manual:document.getElementById('manualTalk'),
  status:document.getElementById('status')
};

Object.values(el).forEach(v=>{
  if(v instanceof HTMLVideoElement) v.play().catch(()=>{});
});

const CFG = {
  warmup_ms: 10000,
  minGap_ms: 25000,
  talkCooldown_ms: 15000,
  idle02Window_ms: 30000,   // ← NEW: micro-expression window after talk
  poll_ms: 2000,

  idle02: () => rand(20000,35000),
  hair:  () => 120000 + rand(-15000,15000),
  fire:  () => rand(240000,300000),
  dance: () => rand(150000,210000),
  silly: () => rand(300000,480000),
  apple: () => rand(1800000,2400000)
};

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}

let mode='idle';
let current=null;
let started=performance.now();
let lastSpecial=started;
let lastTalk=0;

let next={
  idle02: started + CFG.idle02(),
  hair:   started + CFG.hair(),
  fire:   started + CFG.fire(),
  dance:  started + CFG.dance(),
  silly:  started + CFG.silly(),
  apple:  started + CFG.apple()
};

function status(t){el.status.textContent=t}

function hideAll(){
  Object.values(el).forEach(v=>{
    if(v instanceof HTMLVideoElement) v.hidden=true;
  });
}

function showIdle(){
  current=null;
  hideAll();
  el.idle.hidden=false;
  el.idle.play().catch(()=>{});
  status('Idle');
}

function playOnce(name){
  const v=el[name];
  if(!v) return;
  hideAll();
  v.currentTime=0;
  v.loop=false;
  v.hidden=false;
  current=name;
  status('Idle: '+name);
  v.onended=()=>{
    lastSpecial=performance.now();
    next[name]=lastSpecial+CFG[name]();
    showIdle();
  };
  v.play().catch(()=>{});
}

function canSpecial(){
  const now=performance.now();
  return mode==='idle'
    && now-started>CFG.warmup_ms
    && now-lastSpecial>CFG.minGap_ms
    && now-lastTalk>CFG.talkCooldown_ms
    && !current;
}

function canIdle02(){
  const now=performance.now();
  return canSpecial()
    && lastTalk>0
    && now-lastTalk < (CFG.talkCooldown_ms + CFG.idle02Window_ms);
}

setInterval(()=>{
  const n=performance.now();
  if(canIdle02() && n>=next.idle02) return playOnce('idle02');
  if(!canSpecial()) return;
  if(n>=next.apple) return playOnce('apple');
  if(n>=next.dance) return playOnce('dance');
  if(n>=next.silly) return playOnce('silly');
  if(n>=next.hair)  return playOnce('hair');
  if(n>=next.fire)  return playOnce('fire');
},CFG.poll_ms);

showIdle();

/* Voice Detection */

let ctx, analyser, data, raf;
let on=0, off=0;
let manual=false;

function rms(a){
  let s=0;
  for(let i=0;i<a.length;i++) s+=a[i]*a[i];
  return Math.sqrt(s/a.length);
}

function setMode(m){
  if(mode===m) return;
  mode=m;
  if(m==='talk'){
    lastTalk=performance.now();
    hideAll();
    el.talk.hidden=false;
    el.talk.play().catch(()=>{});
    status('Talk');
  } else showIdle();
}

function loop(){
  if(manual){
    setMode('talk');
    lastTalk=performance.now();
  }
  else if(analyser){
    analyser.getFloatTimeDomainData(data);
    const lvl=rms(data);
    const s=el.sens.value/50;
    const onT=0.02*s, offT=0.012*s;
    if(lvl>onT){
      on++; off=0;
      if(on>5) setMode('talk');
      lastTalk=performance.now();
    }
    else if(lvl<offT){
      off++; on=0;
      if(off>12) setMode('idle');
    }
  }
  raf=requestAnimationFrame(loop);
}

async function capture(){
  try{
    let stream=null;
    try{
      stream=await navigator.mediaDevices.getDisplayMedia({audio:true,video:true});
      stream.getVideoTracks().forEach(t=>t.stop());
    }catch{}
    if(!stream) stream=await navigator.mediaDevices.getUserMedia({audio:true});
    ctx=new AudioContext();
    analyser=ctx.createAnalyser();
    analyser.fftSize=1024;
    data=new Float32Array(analyser.fftSize);
    ctx.createMediaStreamSource(stream).connect(analyser);
    loop();
    el.btn.disabled=true;
    el.btn.textContent='Listening…';
  }catch{
    status('Capture failed');
  }
}

el.btn.onclick=capture;
el.manual.onclick=()=>{
  manual=!manual;
  el.manual.textContent=manual?'Manual Talk (ON)':'Manual Talk';
  setMode(manual?'talk':'idle');
};

})();
</script>

</body>
</html>
